# 需求文档

## 简介

Dynamic Input Bypasser（动态输入绕过器）是一个 ComfyUI 自定义节点，用于通过单个开关控制多个输入连接节点的执行状态。该节点提供动态输入槽位管理，允许用户连接任意数量的节点，并通过一个统一的开关来启用或禁用所有连接的节点。

## 术语表

- **Dynamic_Input_Bypasser**: 动态输入绕过器节点，本需求文档描述的核心系统
- **Input_Slot**: 输入槽位，节点上用于接收连接的接口
- **Connected_Node**: 连接节点，通过输入槽位连接到 Dynamic_Input_Bypasser 的源节点
- **Bypass_State**: 绕过状态，节点模式值为 4，表示节点被跳过执行
- **Enable_State**: 启用状态，节点模式值为 0，表示节点正常执行
- **Master_Toggle**: 主开关，用于控制所有连接节点状态的单一切换控件
- **Passthrough_Node**: 透传节点，如 Reroute 节点，仅传递数据不做处理的节点

## 需求

### 需求 1: 动态输入槽位管理

**用户故事:** 作为用户，我希望节点能够自动管理输入槽位，这样我可以连接任意数量的节点而无需手动配置。

#### 验收标准

1. WHEN Dynamic_Input_Bypasser 被创建时，THEN 系统应当初始化一个空的输入槽位
2. WHEN 一个连接被建立到输入槽位时，THEN 系统应当自动添加一个新的空输入槽位
3. WHEN 一个连接从输入槽位断开时，THEN 系统应当移除中间的空槽位，同时保持至少一个空槽位在末尾
4. WHEN 多个连接被依次建立时，THEN 系统应当始终在末尾保持恰好一个空输入槽位
5. THE Dynamic_Input_Bypasser 应当接受任何类型的连接（"*" 通配符类型）
6. THE 输入槽位名称应当显示为连接节点的标题

### 需求 2: 单一主开关控制

**用户故事:** 作为用户，我希望通过一个开关来控制所有连接节点的执行状态，这样我可以快速启用或禁用整个节点组。

#### 验收标准

1. WHEN Dynamic_Input_Bypasser 被创建时，THEN 系统应当显示一个主开关控件
2. WHEN 主开关被设置为"启用"（Enable）时，THEN 系统应当将所有连接的节点设置为 Enable_State（mode = 0）
3. WHEN 主开关被设置为"禁用"（Disable）时，THEN 系统应当将所有连接的节点设置为 Bypass_State（mode = 4）
4. WHEN 用户点击主开关时，THEN 系统应当立即更新所有连接节点的模式
5. THE 主开关应当只有一个，无论连接了多少个节点
6. THE 主开关的名称应当显示为当前 Dynamic_Input_Bypasser 节点的标题

### 需求 3: 节点标题自定义

**用户故事:** 作为用户，我希望能够自定义节点标题，这样主开关可以显示有意义的名称来标识控制的节点组。

#### 验收标准

1. WHEN 用户创建 Dynamic_Input_Bypasser 节点时，THEN 系统应当使用默认标题
2. WHEN 用户修改节点标题时，THEN 系统应当立即更新主开关的显示名称
3. THE 主开关名称应当格式化为"Enable [节点标题]"
4. THE 节点标题应当支持中文和其他 Unicode 字符
5. THE 节点标题修改应当通过双击节点标题或右键菜单实现

### 需求 4: 透传节点跟随

**用户故事:** 作为用户，我希望系统能够自动跟随 Reroute 等透传节点，这样我可以控制实际执行逻辑的节点而不是中间的路由节点。

#### 验收标准

1. WHEN 输入槽位连接到 Reroute 节点时，THEN 系统应当跟随 Reroute 链找到源节点
2. WHEN 输入槽位连接到 Node Combiner 或 Node Collector 时，THEN 系统应当跟随这些透传节点
3. WHEN 跟随透传节点时，THEN 系统应当显示最终源节点的标题作为输入槽位名称
4. WHEN 设置节点模式时，THEN 系统应当设置最终源节点的模式，而不是透传节点
5. THE 系统应当使用 PassThroughFollowing.ALL 策略跟随所有类型的透传节点

### 需求 5: 主开关状态同步

**用户故事:** 作为用户，我希望主开关状态能够反映所有连接节点的实际状态，这样我可以清楚地了解当前配置。

#### 验收标准

1. WHEN 所有连接节点都处于 Enable_State 时，THEN 主开关应当显示为"启用"状态
2. WHEN 所有连接节点都处于 Bypass_State 时，THEN 主开关应当显示为"禁用"状态
3. WHEN 连接节点状态不一致时（部分启用部分禁用），THEN 主开关应当显示为"禁用"状态
4. WHEN 连接节点的模式被外部改变时，THEN 系统应当更新主开关状态以反映变化
5. THE 主开关应当在节点处于 Enable_State 时显示"yes"，处于 Bypass_State 时显示"no"

### 需求 6: 批量节点模式设置

**用户故事:** 作为用户，我希望主开关能够同时控制所有连接的节点，这样我可以一次性切换整个节点组的状态。

#### 验收标准

1. WHEN 主开关从"禁用"切换到"启用"时，THEN 系统应当将所有连接的节点设置为 Enable_State（mode = 0）
2. WHEN 主开关从"启用"切换到"禁用"时，THEN 系统应当将所有连接的节点设置为 Bypass_State（mode = 4）
3. WHEN 设置节点模式时，THEN 系统应当遍历所有输入槽位（除了最后一个空槽位）
4. WHEN 设置节点模式时，THEN 系统应当通过透传节点找到实际的目标节点
5. THE 系统应当使用 changeModeOfNodes 函数确保子图节点被正确处理

### 需求 7: 节点初始化和清理

**用户故事:** 作为系统管理员，我希望节点能够正确初始化和清理资源，这样系统可以保持稳定运行。

#### 验收标准

1. WHEN Dynamic_Input_Bypasser 被添加到图中时，THEN 系统应当初始化一个输入槽位和一个主开关
2. WHEN Dynamic_Input_Bypasser 从图中移除时，THEN 系统应当清理所有控件和事件监听器
3. WHEN 从保存的工作流加载图时，THEN 系统应当恢复所有连接和主开关状态
4. WHEN 节点被序列化时，THEN 系统应当保存主开关的当前状态
5. THE 系统应当添加一个可选的输出槽位"OPT_CONNECTION"用于链式连接
6. THE 节点应当标记为虚拟节点（isVirtualNode = true）

### 需求 8: 用户界面交互

**用户故事:** 作为用户，我希望节点提供直观的用户界面，这样我可以轻松理解和操作节点功能。

#### 验收标准

1. WHEN 用户悬停在主开关上时，THEN 系统应当提供视觉反馈
2. WHEN 用户点击主开关时，THEN 系统应当立即提供视觉状态变化
3. WHEN 节点大小因输入槽位添加/移除而改变时，THEN 系统应当平滑调整节点尺寸
4. THE 节点应当显示清晰的标题以表明其用途
5. THE 主开关应当使用与其他 rgthree 节点一致的样式
6. THE 节点应当在调整大小时保持临时宽度以避免闪烁

### 需求 9: 错误处理

**用户故事:** 作为用户，我希望系统能够优雅地处理错误情况，这样我的工作流不会因为异常而中断。

#### 验收标准

1. WHEN 连接的节点被删除时，THEN 系统应当优雅地移除对应的输入槽位
2. WHEN 检测到循环连接时，THEN 系统应当阻止连接并显示警告信息
3. WHEN 尝试无效连接时，THEN 系统应当拒绝连接而不崩溃
4. WHEN 图结构损坏时，THEN 系统应当记录错误并使用可用数据继续运行
5. THE 系统应当在尝试改变节点模式之前验证所有节点引用
6. THE 系统应当检测输入和输出方向的循环连接

### 需求 10: 性能优化

**用户故事:** 作为用户，我希望节点操作响应迅速，这样我可以流畅地使用大型工作流。

#### 验收标准

1. WHEN 连接发生变化时，THEN 系统应当使用防抖机制延迟 100ms 后再进行稳定化处理
2. WHEN 更新主开关状态时，THEN 系统应当批量更新 UI 以最小化重绘
3. WHEN 处理批量节点模式设置时，THEN 系统应当使用高效算法避免冗余的节点访问
4. THE 系统应当使用 Promise 防抖避免重复的稳定化调度
5. THE 系统应当在完成稳定化后每 500ms 进行一次监控更新
6. THE 系统应当在调整大小时使用临时宽度缓存和 32ms 防抖

### 需求 11: 兼容性

**用户故事:** 作为开发者，我希望新节点能够与现有的 ComfyUI 和 rgthree 生态系统兼容，这样用户可以无缝集成到现有工作流中。

#### 验收标准

1. THE Dynamic_Input_Bypasser 应当遵循 rgthree 节点命名约定
2. THE Dynamic_Input_Bypasser 应当集成到 ComfyUI 节点注册系统
3. THE Dynamic_Input_Bypasser 应当使用标准 LiteGraph 节点模式（0 表示 ALWAYS，4 表示 BYPASS）
4. THE Dynamic_Input_Bypasser 应当兼容 ComfyUI 的序列化格式
5. THE Dynamic_Input_Bypasser 应当与其他 rgthree 节点（如 Fast Bypasser 和 Fast Groups Bypasser）正确协作
6. THE Dynamic_Input_Bypasser 应当支持连接布局配置（左右、上下等）
7. THE Dynamic_Input_Bypasser 应当支持连接折叠显示功能

### 需求 12: 子图支持

**用户故事:** 作为用户，我希望节点能够正确处理子图节点，这样我可以控制包含子图的复杂工作流。

#### 验收标准

1. WHEN 连接的节点是子图节点时，THEN 系统应当递归设置子图内所有节点的模式
2. WHEN 改变子图节点的模式时，THEN 系统应当使用深度优先遍历处理所有子节点
3. THE 系统应当使用 changeModeOfNodes 函数确保子图节点被正确处理
4. THE 系统应当避免在子图遍历时产生无限循环
5. THE 系统应当正确处理嵌套子图的情况

## 与 Fast Bypasser 的区别

| 特性 | Fast Bypasser | Dynamic Input Bypasser |
|------|---------------|------------------------|
| 控件数量 | 每个连接一个开关 | 所有连接共用一个主开关 |
| 开关名称 | 显示连接节点的标题 | 显示当前节点的标题 |
| 控制粒度 | 可以单独控制每个节点 | 统一控制所有节点 |
| 使用场景 | 需要独立控制多个节点 | 需要整体控制一组节点 |
| 界面复杂度 | 连接越多，控件越多 | 始终只有一个控件 |

## 设计理念

Dynamic Input Bypasser 的设计理念是提供一个**简洁的主开关**来控制一组相关的节点，而不是为每个连接提供单独的控件。这种设计适合以下场景：

1. **工作流分支切换** - 快速启用/禁用整个工作流分支
2. **调试和测试** - 临时禁用一组节点进行调试
3. **性能优化** - 跳过不需要的处理步骤
4. **条件执行** - 根据条件启用/禁用特定的处理流程

通过自定义节点标题，用户可以为主开关赋予有意义的名称，如"启用高清放大"、"启用面部修复"等，使工作流更加清晰易懂。
