# 实现计划: Dynamic Input Bypasser

## 概述

本实现计划将 Dynamic Input Bypasser 节点分解为离散的编码步骤。该节点完全独立实现，不依赖 rgthree 节点库，仅使用 ComfyUI 核心功能。

## 任务

- [x] 1. 创建项目结构和基础文件
  - [x] 创建节点 JavaScript 文件 (dynamic_input_bypasser.js)
  - [x] 创建 Python 注册文件 (dynamic_input_bypasser.py)
  - [x] 更新 __init__.py 注册节点
  - [x] 设置基础导入和导出
  - _需求: 7.1, 11.1, 11.2_
  - **状态**: ✅ 完成

- [x] 2. 实现工具函数模块
  - [x] 2.1 实现 isPassthroughNode 函数
    - 判断节点是否为透传节点（Reroute、PrimitiveNode）
    - _需求: 4.1, 4.2_
  
  - [x] 2.2 实现 getConnectedNodes 函数
    - 获取输入槽位连接的节点
    - 跟随透传节点链找到最终源节点
    - 处理空引用和无效连接
    - _需求: 4.1, 4.2, 4.3, 4.4, 9.1_
  
  - [x] 2.3 实现 setNodesMode 函数
    - 使用栈实现深度优先遍历
    - 递归设置节点模式（包括子图）
    - 使用访问标记避免重复访问
    - _需求: 6.1, 6.2, 12.1, 12.2, 12.4_
  
  - [x] 2.4 实现 hasCircularConnection 函数
    - 检测从当前节点到目标节点是否存在路径
    - 使用广度优先搜索遍历输出连接
    - 避免无限循环
    - _需求: 9.2, 9.6_
  - **状态**: ✅ 完成

- [x] 3. 实现 DynamicInputBypasserNode 类基础结构
  - [x] 3.1 创建类定义和构造函数
    - 继承 LGraphNode
    - 设置节点类型和标题
    - 初始化模式配置（modeOn=0, modeOff=4）
    - 初始化内部状态变量
    - _需求: 7.1, 11.3_
  
  - [x] 3.2 添加初始输入和输出槽位
    - 添加第一个空输入槽位（type="*"）
    - 添加可选输出槽位 "OPT_CONNECTION"
    - _需求: 1.1, 1.5, 7.5_
  - **状态**: ✅ 完成

- [x] 4. 实现主开关功能
  - [x] 4.1 实现 addMasterToggle 方法
    - 创建 toggle 类型的 widget
    - 设置名称格式为 "Enable [节点标题]"
    - 配置选项 { on: "yes", off: "no" }
    - 绑定切换回调函数
    - _需求: 2.1, 2.6, 3.3_
  
  - [ ] 4.2 实现主开关切换逻辑
    - 获取所有连接的节点
    - 根据开关状态确定目标模式
    - 批量设置所有节点的模式
    - 更新主开关状态
    - _需求: 2.2, 2.3, 2.4, 6.1, 6.2_
  
  - [ ] 4.3 实现 syncMasterToggle 方法
    - 检查所有连接节点的模式
    - 更新主开关状态以反映实际情况
    - 处理混合状态（部分启用部分禁用）
    - _需求: 5.1, 5.2, 5.3, 5.4_

- [ ] 5. 实现动态输入槽位管理
  - [ ] 5.1 实现 stabilizeInputs 方法
    - 检查最后一个输入槽位是否被连接
    - 如果被连接，自动添加新的空槽位
    - 移除中间的空槽位（保留末尾空槽位）
    - 更新输入槽位名称为连接节点的标题
    - _需求: 1.2, 1.3, 1.4, 1.6, 7.3_
  
  - [ ] 5.2 实现 getAllConnectedNodes 方法
    - 遍历所有输入槽位（除最后一个空槽位）
    - 使用 getConnectedNodes 获取每个槽位的连接节点
    - 收集所有连接节点并返回
    - _需求: 6.3, 6.4_

- [ ] 6. 实现连接变化处理
  - [ ] 6.1 实现 onConnectionsChange 方法
    - 监听连接建立和断开事件
    - 调度稳定化处理
    - _需求: 1.2, 1.3_
  
  - [ ] 6.2 实现 scheduleStabilize 方法
    - 使用 Promise 实现防抖机制
    - 默认延迟 100ms
    - 避免重复调度
    - 执行 stabilizeInputs 和 syncMasterToggle
    - _需求: 10.1, 10.4_

- [ ] 7. 实现循环连接检测
  - [ ] 7.1 实现 onConnectInput 方法
    - 在建立输入连接前检测循环
    - 使用 hasCircularConnection 检测
    - 如果检测到循环，显示警告并阻止连接
    - _需求: 9.2, 9.6_
  
  - [ ] 7.2 实现 onConnectOutput 方法
    - 在建立输出连接前检测循环
    - 使用 hasCircularConnection 检测
    - 如果检测到循环，显示警告并阻止连接
    - _需求: 9.2, 9.6_

- [ ] 8. 实现性能优化
  - [ ] 8.1 实现临时宽度缓存机制
    - 重写 addInput 方法，设置 _tempWidth
    - 重写 removeInput 方法，设置 _tempWidth
    - 重写 addWidget 方法，设置 _tempWidth
    - 重写 removeWidget 方法，设置 _tempWidth
    - _需求: 8.6_
  
  - [ ] 8.2 实现 computeSize 方法
    - 调用父类 computeSize
    - 如果存在 _tempWidth，使用临时宽度
    - 32ms 后清除 _tempWidth
    - _需求: 8.6, 10.6_

- [ ] 9. 实现节点标题同步
  - [ ] 9.1 监听节点标题变化
    - 重写 onPropertyChanged 或使用其他机制
    - 当标题改变时更新主开关名称
    - _需求: 3.2, 3.3_

- [ ] 10. 实现节点注册和集成
  - [ ] 10.1 创建 ComfyUI 扩展注册代码
    - 使用 app.registerExtension 注册节点
    - 实现 beforeRegisterNodeDef 钩子
    - 设置节点类型映射
    - _需求: 11.1, 11.2_
  
  - [ ] 10.2 创建 Python 后端注册
    - 定义 NODE_CLASS_MAPPINGS
    - 定义 NODE_DISPLAY_NAME_MAPPINGS
    - 实现节点类（如果需要后端逻辑）
    - _需求: 11.2, 11.4_

- [ ] 11. 测试和验证
  - [ ] 11.1 创建基础单元测试
    - 测试节点初始化
    - 测试工具函数
    - 测试输入槽位管理
    - _需求: 所有_
  
  - [ ] 11.2 创建集成测试
    - 测试与 Reroute 节点协作
    - 测试与子图节点协作
    - 测试工作流保存和加载
    - _需求: 4.1, 12.1_
  
  - [ ] 11.3 手动测试
    - 在 ComfyUI 中创建节点
    - 测试动态输入添加
    - 测试主开关功能
    - 测试循环连接检测
    - 测试性能（连接 100 个节点）

- [ ] 12. 文档和部署
  - [ ] 12.1 创建 README 文档
    - 节点功能说明
    - 使用示例
    - 安装说明
  
  - [ ] 12.2 创建示例工作流
    - 基础使用示例
    - 与 Reroute 配合使用
    - 复杂场景示例

## 注意事项

1. **独立实现** - 所有功能自己实现，不依赖 rgthree
2. **错误处理** - 每个方法都要处理空引用和异常情况
3. **性能优化** - 使用防抖和缓存机制
4. **测试优先** - 实现功能后立即测试
5. **渐进式开发** - 先实现核心功能，再添加优化

## 实现顺序

建议按以下顺序实现：
1. 工具函数（任务 2）- 基础设施
2. 类基础结构（任务 3）- 节点框架
3. 主开关功能（任务 4）- 核心功能
4. 动态输入管理（任务 5）- 核心功能
5. 连接变化处理（任务 6）- 自动化
6. 循环检测（任务 7）- 安全性
7. 性能优化（任务 8）- 用户体验
8. 标题同步（任务 9）- 细节完善
9. 注册集成（任务 10）- 部署
10. 测试验证（任务 11）- 质量保证
11. 文档部署（任务 12）- 交付

## 检查点

- [ ] Checkpoint 1: 工具函数和基础结构完成后
  - 确保所有工具函数正常工作
  - 确保节点可以创建和显示
  - 询问用户是否继续

- [ ] Checkpoint 2: 核心功能完成后
  - 确保主开关可以控制节点
  - 确保动态输入正常工作
  - 询问用户是否继续

- [ ] Checkpoint 3: 所有功能完成后
  - 确保所有测试通过
  - 确保性能满足要求
  - 询问用户是否满意


---

## 实现进度更新

### 已完成的任务 (2025-01-02)

✅ **任务 1-10**: 所有核心实现已完成
- 创建了完整的项目结构
- 实现了所有工具函数（isPassthroughNode, getConnectedNodes, setNodesMode, hasCircularConnection）
- 实现了 DynamicInputBypasserNode 类的完整功能
- 实现了主开关功能和动态输入管理
- 实现了连接变化处理和循环检测
- 实现了性能优化（防抖、临时宽度缓存）
- 实现了节点标题同步
- 完成了节点注册（JavaScript 和 Python）
- 更新了 `__init__.py` 文件，节点已注册到 ComfyUI

### 待完成的任务

⏳ **任务 11**: 测试和验证
- 需要在 ComfyUI 中加载节点并进行功能测试
- 测试动态输入添加
- 测试主开关控制功能
- 测试透传节点跟随
- 测试循环连接检测
- 性能测试

⏳ **任务 12**: 文档和部署
- 创建使用文档（可选）
- 创建示例工作流（可选）

### 下一步

1. 重启 ComfyUI 或重新加载自定义节点
2. 在节点菜单中找到 "BenNodes/控制" 分类下的 "动态输入绕过器 🔀-Ben"
3. 测试节点功能是否正常工作
4. 如有问题，检查浏览器控制台和 ComfyUI 日志
